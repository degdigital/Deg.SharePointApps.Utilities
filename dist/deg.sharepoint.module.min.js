"use strict";var shpUtility=angular.module("Deg.SharePoint",[]);shpUtility.factory("shpCommon",function(){function e(e){for(var t,o=[],r=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),n=0;n<r.length;n++)t=r[n].split("="),o.push(t[0]),o[t[0]]=t[1];return o[e]}function t(e){$.ajax({url:r()+"/_api/contextinfo",type:"POST",headers:{accept:"application/json;odata=verbose",contentType:"text/xml"},success:function(t){var o=t.d.GetContextWebInformation.FormDigestValue;e&&e({error:!1,requestDigest:o})},error:function(t){e&&e({error:!0,errorMessage:JSON.stringify(t)})}})}function o(e){e=e.replace("http://",""),e=e.replace("https://","");for(var t=e.split("/"),o="/",r=1;r<t.length;r++)o+=t[r]+"/";return o}function r(){return decodeURIComponent(e("SPAppWebUrl"))}function n(){return decodeURIComponent(e("SPHostUrl"))}function s(){var e=n(),t=new SP.ClientContext(o(e));return t}return{GetFormDigest:t,SPAppWebUrl:r(),SPHostUrl:n(),HostWebContext:s(),GetQsParam:e,GetRelativeUrlFromAbsolute:o}}),shpUtility.factory("shpColumn",["$http","shpCommon",function(e,t){function o(e,t){function o(){i++,t&&e.length===i&&t(l)}for(var n=SP.ClientContext.get_current(),s=r||n,i=0,a=s.get_web().get_fields(),l={ErrorMessages:[],Fields:[]},u=0;u<e.length;u++){var c=a.addFieldAsXml(e[u],!1,SP.AddFieldOptions.AddToNoContentType);s.load(c),l.Fields.push(c),s.executeQueryAsync(function(){$log.log("Field provisioned in host web successfully"),o()},function(e,t){$log.log("Failed to provision field into host web."),l.ErrorMessages.push(t.get_message()),o()})}}var r=t.HostWebContext;return{CreateAtHost:o}}]),shpUtility.factory("shpContentType",function(){function e(e,t,o){function r(){t&&t(l)}function n(e,t){$log.log("Error: "+t.get_message())}var s=o||clientCtx,i=s.get_web(),a=i.get_contentTypes(),l=new SP.ContentTypeCreationInformation;if(l.set_name(e.Name),l.set_description(e.Description),l.set_group(e.Group),e.ParentContentType&&""!=e.ParentContentType){var u=a.getById(e.ParentContentType);l.set_parentContentType(u)}a.add(l),s.load(a),s.executeQueryAsync(r,n)}return{CreateAtHost:function(t,o){var r=getHostWebContext();e(t,o,r)}}}),shpUtility.factory("shpFile",["$http","shpCommon",function(e,t){function o(t,o,i,a,l){e.get(t).success(function(e){if(void 0!==e&&e.length>0)if(a){var t=o+"/"+i;n(t,function(n){var u=n.Success;u?s(t,function(t){t.Success?r(o,i,e,a,l):l&&l(t)}):r(o,i,e,a,l)})}else r(o,i,e,a,l);else l&&l({Success:!1,Message:"Failed to read file from app web."})}).error(function(e,t){l&&l({Success:!1,Message:"Request for file in app web failed: "+t})})}function r(e,o,r,n,s){function l(){var t=e+"/"+o;n?i(t,function(e){s&&s(e)}):s&&s({Success:!0,Message:"File published in host web successfully: "+t})}function u(e,t){s&&s({Success:!1,Message:"Failed to provision file into host web. Error: "+e.statusCode})}var c=a,g=new SP.ClientContext(t.GetRelativeUrlFromAbsolute(c)),p=new SP.FileCreationInformation;p.set_content(new SP.Base64EncodedByteArray);for(var f=0;f<r.length;f++)p.get_content().append(r.charCodeAt(f));p.set_overwrite(!0),p.set_url(o);var d=g.get_web().getFolderByServerRelativeUrl(e).get_files();g.load(d),d.add(p),g.executeQueryAsync(l,u)}function n(e,o){function r(){o&&o({Success:!0,Message:"File loaded from host web successfully: "+l})}function n(e,t){o&&o({Success:!1,Message:"Failed to read file from host web. Error: "+e.statusCode})}var s=t.GetRelativeUrlFromAbsolute(a),i=new SP.ClientContext(s),l=s+e,u=i.get_web().getFileByServerRelativeUrl(l);i.load(u),i.executeQueryAsync(r,n)}function s(e,o){function r(){var t=0==p.get_checkOutType();t?o&&o({Success:!0,Message:"File checked out in host web successfully: "+e}):(p.checkOut(),c.executeQueryAsync(s,i))}function n(e,t){o&&o({Success:!1,Message:"Failed to read file from host web. Error: "+e.statusCode})}function s(){o&&o({Success:!0,Message:"File checked out in host web successfully: "+e})}function i(e,t){o&&o({Success:!1,Message:"Failed to checkout file at host web. Error: "+e.statusCode})}var l=a,u=t.GetRelativeUrlFromAbsolute(l),c=new SP.ClientContext(t.GetRelativeUrlFromAbsolute(l)),g=u+e,p=c.get_web().getFileByServerRelativeUrl(g);c.load(p),c.executeQueryAsync(r,n)}function i(e,o){function r(){var t=0==p.get_checkOutType();t?o&&o({Success:!0,Message:"File published in host web successfully: "+e}):(p.checkIn(),p.publish(),c.executeQueryAsync(s,i))}function n(e,t){o&&o({Success:!1,Message:"Failed to read file from host web. Error: "+e.statusCode})}function s(){o&&o({Success:!0,Message:"File published in host web successfully: "+e})}function i(e,t){o&&o({Success:!1,Message:"Failed to publish file into host web. Error: "+e.statusCode})}var l=a,u=t.GetRelativeUrlFromAbsolute(l),c=new SP.ClientContext(t.GetRelativeUrlFromAbsolute(l)),g=u+e,p=c.get_web().getFileByServerRelativeUrl(g);c.load(p),c.executeQueryAsync(r,n)}var a=t.SPHostUrl;t.SPAppWebUrl;return{CreateAtHost:o,LoadAtHost:n,CheckOutAtHost:s,PublishFileToHost:i,UploadFileToHostWeb:r}}]),shpUtility.factory("shpGroup",["$http","shpCommon",function(e,t){function o(e,o){function r(){o&&o({Success:!0,Message:"Group loaded from host web successfully"})}function n(e,t){o&&o({Success:!1,Message:"Failed to load group from host web. Error: "+t.get_message()})}var i=s,a=(t.GetRelativeUrlFromAbsolute(i),new SP.ClientContext(t.GetRelativeUrlFromAbsolute(i))),l=a.get_web().get_siteGroups(),u=l.getByName(e);a.load(u),a.executeQueryAsync(r,n)}function r(e,o){function r(){o&&o({Success:!0,Message:"Group created at host web successfully"})}function n(e,t){o&&o({Success:!1,Message:"Failed to create group at host web. Error: "+t.get_message()})}var i=s,a=(t.GetRelativeUrlFromAbsolute(i),new SP.ClientContext(t.GetRelativeUrlFromAbsolute(i))),l=new SP.GroupCreationInformation;l.set_title(e);var u=a.get_web().get_siteGroups().add(l);a.load(u),a.executeQueryAsync(r,n)}function n(e,o){function r(e,t){for(var r=!1,n=g.getEnumerator();n.moveNext();){var s=n.get_current();if(s.get_id()==c.get_id()){r=!0;break}}o&&o({Success:!0,IsUserInGroup:r})}function n(e,t){o&&o({Success:!1,Message:"Failed to create group at host web. Error: "+t.get_message()})}var i=s,a=(t.GetRelativeUrlFromAbsolute(i),new SP.ClientContext(t.GetRelativeUrlFromAbsolute(i))),l=a.get_web().get_siteGroups(),u=l.getByName(e);a.load(u);var c=a.get_web().get_currentUser();a.load(c);var g=u.get_users();a.load(g),a.executeQueryAsync(r,n)}var s=t.SPHostUrl;t.SPAppWebUrl;return{LoadAtHost:o,CreateAtHost:r,IsCurrentUserMember:n}}]),shpUtility.factory("shpItem",["$log","$q","shpCommon",function(e,t,o){function r(t,o,r){function n(){r&&r()}var s=new SP.ClientContext(a),l=new SP.AppContextSite(s,i),u=l.get_web().get_lists().getByTitle(t),c=new SP.ListItemCreationInformation,g=u.addItem(c);angular.forEach(o,function(e,t){if("currentuser"==e){var o=l.get_web().get_currentUser();g.set_item(t,o)}else g.set_item(t,e)}),g.update(),s.load(g),s.executeQueryAsync(function(e,t){n()},function(t,o){e.log("Request failed. "+o.get_message()+"\n"+o.get_stackTrace())})}function n(e,o,r){var n=t.defer(),s=o?o:"<View><Query></Query></View>",l=new SP.ClientContext(a),u=new SP.AppContextSite(l,i),c=u.get_web().get_lists().getByTitle(e),g=new SP.CamlQuery;g.set_viewXml(s);var p=c.getItems(g);return l.load(p),l.executeQueryAsync(Function.createDelegate(this,function(){for(var e=[],t=p.get_count(),o=0;t>o;o++){var r=p.itemAt(o);e.push(r.get_fieldValues())}n.resolve(e)}),Function.createDelegate(this,function(){n.reject("An error has occurred when retrieving items")})),n.promise}function s(e,o,r){var n=t.defer(),s=new SP.ClientContext(a),l=new SP.AppContextSite(s,i),u=l.get_web().get_lists().getByTitle(e),c=u.getItemById(o);return angular.forEach(r,function(e,t){c.set_item(t,e)}),c.update(),s.executeQueryAsync(Function.createDelegate(this,function(){n.resolve()}),Function.createDelegate(this,function(){n.reject("An error has occurred when updating the item.")})),n.promise}var i=o.SPHostUrl,a=o.SPAppWebUrl;return{Create:r,GetAll:n,Update:s}}]),shpUtility.factory("shpList",["$log","$q","shpCommon",function(e,t,o){function r(o,r,n){function s(){r&&r(),l.resolve()}var l=t.defer(),u=new SP.ClientContext(a),c=new SP.AppContextSite(u,i),g=c.get_web(),p=new SP.ListCreationInformation;p.set_title(o),p.set_templateType(n);var f=g.get_lists().add(p);u.load(f),u.executeQueryAsync(function(e,t){s()},function(t,r){e.log("Request failed. "+r.get_message()+"\n"+r.get_stackTrace()),l.reject("Error creating "+o+" at host.")})}function n(o,r,n,s,l,u,c){function g(){c&&c(),p.resolve()}var p=t.defer(),f=new SP.ClientContext(a),d=new SP.AppContextSite(f,i),m=d.get_web().get_lists().getByTitle(o),y="";switch(l){case"URL":case"DateTime":""!=u&&(y="Format='"+u+"'");break;case"Note":""!=u&&(y="RichText='"+(u?"TRUE":"FALSE")+"'");break;case"User":""!=u&&(y="UserSelectionMode='"+u+"'")}var h=s?"TRUE":"FALSE",C="<Field DisplayName='"+r+"' Name='"+n+"' Required='"+h+"' Type='"+l+"' "+y+"/>",S=m.get_fields().addFieldAsXml(C,!0,SP.AddFieldOptions.addFieldInternalNameHint);switch(f.load(S),l){case"Choice":var v=f.castTo(S,SP.FieldChoice);v.set_choices(u),v.update(),f.executeQueryAsync(function(e,t){g()},function(t,o){e.log("Request failed. "+o.get_message()+"\n"+o.get_stackTrace()),p.reject()});break;case"TaxonomyFieldType":case"TaxonomyFieldTypeMulti":if(u){var _=SP.Taxonomy.TaxonomySession.getTaxonomySession(f),A=_.getDefaultSiteCollectionTermStore(),b=A.get_groups().getByName(u.TaxonomyGroup),P=b.get_termSets().getByName(u.TaxonomySet);f.load(A,"Id"),f.load(P,"Id"),f.executeQueryAsync(function(t,o){var r=f.castTo(S,SP.Taxonomy.TaxonomyField);r.set_sspId(A.get_id()),r.set_termSetId(P.get_id()),r.set_createValuesInEditForm(u.CreateValuesInEditForm),r.set_allowMultipleValues(u.AllowMultipleValues),r.update(),f.executeQueryAsync(function(e,t){g()},function(t,o){e.log("Request failed. "+o.get_message()+"\n"+o.get_stackTrace()),p.reject()})},function(e,t){alert("Error creating TaxonomyFieldType")})}break;default:f.executeQueryAsync(function(e,t){g()},function(t,o){e.log("Request failed. "+o.get_message()+"\n"+o.get_stackTrace()),p.reject()})}return p.promise}function s(o,r){function n(){r&&r()}var s=t.defer(),l=new SP.ClientContext(a),u=new SP.AppContextSite(l,i),c=u.get_web().get_lists().getByTitle(o);return l.load(c),l.executeQueryAsync(function(e,t){n(),s.resolve()},function(t,o){e.log("Request failed. "+o.get_message()+"\n"+o.get_stackTrace()),s.reject()}),s.promise}var i=o.SPHostUrl,a=o.SPAppWebUrl;return{CreateAtHost:r,AddFieldToListAtHost:n,Exist:s}}]),shpUtility.factory("shpPropertyBag",["$log","$http","shpCommon",function(e,t,o){function r(e,t){var o=clientCtx.get_web();savePropertyBag(o,e,t)}function n(e,t){var o=clientCtx.get_site().get_rootWeb();savePropertyBag(o,e,t)}function s(o,r,n){var s=n||i,a=s+"/_api/web/AllProperties?$select="+o;t.get(a).success(function(e){var t="";e[o]&&(t=e[o]),r(t)}).error(function(t,o){e.log(o),e.log(t)})}var i=(o.SPHostUrl,o.SPAppWebUrl);return{SaveObjToCurrentWeb:r,SaveObjToRootWeb:n,GetValue:s}}]),shpUtility.factory("shpUser",["$log","$q","shpCommon",function(e,t,o){function r(t){function o(){var e=s.get_title();t(e)}function r(t,o){e.log("Failed to get user name. Error:"+o.get_message())}try{var n=SP.ClientContext.get_current(),s=n.get_web().get_currentUser();n.load(s),n.executeQueryAsync(o,r)}catch(i){t(null)}}function n(t){function o(){t&&t(s)}function r(t,o){e.log("Failed to get user. Error: "+o.get_message())}var n=SP.ClientContext.get_current(),s=n.get_web().get_currentUser();n.load(s),n.executeQueryAsync(o,r)}function s(t,o){function r(){o&&o(i.get_id())}function n(t,o){e.log("Failed to ensure user. Error: "+o.get_message())}var s=SP.ClientContext.get_current(),i=s.get_web().ensureUser(t);s.load(i),s.executeQueryAsync(r,n)}function i(){var e=t.defer(),o=SP.ClientContext.get_current(),r=new SP.UserProfiles.PeopleManager(o),n=r.getMyProperties();return o.load(n),o.executeQueryAsync(function(){e.resolve(n.get_userProfileProperties())},function(t){console.log(t),e.reject(t),console.log("Error")}),e.promise}return{GetCurrentUserName:r,GetCurrent:n,GetId:s,GetCurrentUserProfileProperties:i}}]),shpUtility.factory("shpTaxonomy",["$http",function(e){function t(e,t,o){var r=SP.ClientContext.get_current(),n=SP.Taxonomy.TaxonomySession.getTaxonomySession(r),s=n.getDefaultSiteCollectionTermStore(),i=s.get_groups().getByName(e),a=i.get_termSets().getByName(t),l=a.getAllTerms();r.load(l),r.executeQueryAsync(function(){for(var e=[],t=l.getEnumerator();t.moveNext();){var r=t.get_current();e.push({id:r.get_id(),name:r.get_name()})}o&&o(e)},function(e,t){$log.log(t.get_message())})}return{GetTermSetValues:t}}]),shpUtility.service("spService",["$http","$log","$q","shpCommon","shpUser","shpPropertyBag","shpItem","shpList","shpContentType","shpFile","shpColumn","shpGroup","shpTaxonomy",function(e,t,o,r,n,s,i,a,l,u,c,g,p){return{User:{GetCurrentUserName:n.GetCurrentUserName,GetCurrent:n.GetCurrent,GetId:n.GetId,GetCurrentUserProfileProperties:n.GetId},CtxInfo:{SPAppWebUrl:r.SPAppWebUrl,SPHostUrl:r.SPHostUrl},PropBag:{SaveObjToCurrentWeb:s.SaveObjToCurrentWeb,SaveObjToRootWeb:s.SaveObjToRootWeb,GetValue:s.GetValue},Utilities:{GetFormDigest:r.GetFormDigest,HostWebContext:r.HostWebContext,GetQsParam:r.GetQsParam},Lists:{CreateAtHost:a.CreateAtHost,AddFieldToListAtHost:a.AddFieldToListAtHost,Exist:a.Exist},Items:{Create:i.Create,GetAll:i.GetAll,Update:i.Update},Columns:{CreateAtHost:c.CreateAtHost},CTypes:{CreateAtHost:l.CreateAtHost},Files:{CreateAtHost:u.CreateAtHost,LoadAtHost:u.LoadAtHost,CheckOutAtHost:u.CheckOutAtHost,PublishFileToHost:u.PublishFileToHost,UploadFileToHostWeb:u.UploadFileToHostWeb},Groups:{LoadAtHost:g.LoadAtHost,CreateAtHost:g.CreateAtHost,IsCurrentUserMember:g.IsCurrentUserMember},Taxonomy:{GetTermSetValues:p.GetTermSetValues}}}]),shpUtility.directive("ngAppFrame",["$timeout","$window",function(e,t){function o(e){var o=RegExp("[?&]"+e+"=([^&]*)").exec(t.location.search);return o&&decodeURIComponent(o[1].replace(/\+/g," "))}return{restrict:"E",link:function(r,n,s){n.css("display","block"),r.$watch(function(){return n[0].offsetHeight},function(r,n){e(function(){"undefined"==typeof s.minheight&&(s.minheight=50);var e=s.minheight?r+parseInt(s.minheight):r,n=o("SenderId"),i="<message senderId="+n+">resize(100%,"+e+")</message>";t.parent.postMessage(i,"*")},0)})}}}]),shpUtility.directive("ngChromeControl",["$window",function(e){return{restrict:"E",link:function(e,t,o){t.attr("id","chrome_ctrl_placeholder");var r={appIconUrl:o.appiconurl,appTitle:o.apptitle};o.apphelppageurl&&(r.appHelpPageUrl=o.apphelppageurl);var n=new SP.UI.Controls.Navigation(t[0].id,r);n.setVisible(!0),e.$watch(function(){return o.apptitle},function(e,o){e!=o&&t.find(".ms-core-pageTitle").text(e)})}}}]),shpUtility.directive("ngPeoplePicker",function(){function e(e,t,o,r){function n(){var e=s+"_TopSpan",t=SPClientPeoplePicker.SPClientPeoplePickerDict[e],o=t.GetAllUserInfo(),n=[];i?angular.forEach(o,function(e){n.push(e.AutoFillKey)}):angular.forEach(o,function(e){n.push(e.EntityData.Email)}),a.AllowMultipleValues?r.$setViewValue(n):n.length>0&&r.$setViewValue(n[0])}var s=o.id,i="username"==o.ngPeoplePicker,a={SearchPrincipalSource:15,ResolvePrincipalSource:15,MaximumEntitySuggestions:50,Width:"100%",OnUserResolvedClientScript:n};a.Required=!0,a.PrincipalAccountType="User,DL",o.allowmultiple?a.AllowMultipleValues=!0:a.AllowMultipleValues=!1,SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SPClientPeoplePicker_InitStandaloneControlWrapper(s,null,a)})}return{restrict:"A",require:"ngModel",link:e}});